# 精确枚举与自动切换功能

## 功能概述

我们已成功实现了任务B：两人/小规模精确枚举模块和自动切换机制，为德州扑克胜率计算提供了精确解和智能方法选择。

## 核心特性

### 1. 精确枚举算法
- **完全枚举**：对于已知对手手牌的小规模场景，枚举所有可能的公共牌组合
- **零误差**：枚举结果为真实概率，CI半径为0.0
- **复杂度控制**：智能复杂度估算，超过阈值自动拒绝
- **内存优化**：高效的组合生成算法，避免内存爆炸

### 2. 智能自动调度
- **场景识别**：根据对手数量、已知信息、复杂度自动选择方法
- **无缝切换**：用户无需关心底层实现，获得最优计算方法
- **降级机制**：枚举失败时自动降级到Monte Carlo
- **性能平衡**：在精度和效率之间找到最佳平衡点

### 3. 灵活的方法控制
- **自动模式**（默认）：根据场景复杂度智能选择
- **强制枚举**：`--force-enum`强制使用精确枚举
- **强制Monte Carlo**：`--force-mc`强制使用模拟方法
- **详细推理**：`--verbose`显示方法选择的具体原因

## 技术实现

### 模块架构
```
src/core/
├── enumeration.py          # 精确枚举核心算法
├── dispatcher.py           # 自动调度器
├── monte_carlo.py          # Monte Carlo算法（任务A）
└── equity_result.py        # 统一结果结构
```

### 决策矩阵

| 场景 | 对手数 | 随机对手 | 公共牌 | 选择方法 | 原因 |
|------|--------|----------|--------|----------|------|
| AA vs KK | 1 | 0 | 3+ | ENUM | 已知对手+晚期街道 |
| AA vs random | 1 | 1 | 3+ | ENUM | 单随机+晚期街道 |
| AA vs random | 1 | 1 | 0-2 | MC | 早期街道复杂度高 |
| AA vs 2 randoms | 2 | 2 | any | MC | 多随机对手 |
| AA vs KK,QQ | 2 | 0 | 4+ | ENUM | 多已知+晚期街道 |
| 4+ opponents | 4+ | any | any | MC | 对手数量过多 |

### 复杂度估算算法
- **已知对手**：复杂度 = C(剩余牌数, 剩余公共牌数)
- **随机对手**：复杂度 = 公共牌组合 × 对手手牌组合乘积
- **阈值设定**：保守限制500,000组合以内使用枚举

## 使用示例

### 自动选择（推荐）
```bash
# 会自动选择枚举（已知对手，flop）
python -m src.product.cli --hero "As Ad" --villains "Kh Ks" --community "2c 7h Jd" --auto

# 会自动选择Monte Carlo（多对手）
python -m src.product.cli --hero "As Ad" --villains "random,random" --auto
```

### 强制指定方法
```bash
# 强制枚举
python -m src.product.cli --hero "Js Jd" --villains "Ah Kh" --community "2c 7h Jd 3s" --force-enum

# 强制Monte Carlo
python -m src.product.cli --hero "Js Jd" --villains "Ah Kh" --community "2c 7h Jd 3s" --force-mc
```

### 详细推理过程
```bash
python -m src.product.cli --hero "As Ad" --villains "Kh Ks" --community "2c 7h Jd" --auto --verbose

# 输出包含：
# Method: ENUM - exact enumeration feasible (≤2 opponents (1), ≤1 random opponent (0))
```

## 性能对比

### 精确度
- **枚举**：真实概率，零误差
- **Monte Carlo**：统计估计，有置信区间

### 计算时间
- **简单场景（枚举适用）**：枚举 < 1秒，MC 需要数秒到分钟
- **复杂场景（MC适用）**：枚举不可行，MC 自动切换

### 适用范围
- **枚举**：≤2对手，大部分已知信息，晚期街道
- **Monte Carlo**：所有场景，特别是多对手、早期街道

## 验证测试

### 7项完整测试
1. ✅ 枚举结果准确性测试
2. ✅ 自动切换到枚举测试
3. ✅ 多对手自动切换到MC测试
4. ✅ 复杂度限制测试
5. ✅ 错误处理测试
6. ✅ 强制方法测试
7. ✅ 已知对手枚举测试

### 实际案例验证
```bash
# AA vs KK flop: 91.6% (枚举) vs ~92% (理论值)
# QQ vs AK flop: 74.4% (枚举) - 准确反映board texture
# JJ set vs AK: 100% (枚举) - 完美捕获nuts场景
```

## 与任务A的集成

- **统一接口**：两种方法返回相同的`EquityResult`结构
- **一致性**：种子控制对两种方法都有效
- **互补性**：枚举处理精确场景，MC处理复杂场景
- **无缝体验**：用户获得最佳方法而无需了解细节

## 下一步拓展

基于此基础，可以继续实现：
- **任务C**：范围解析+加权抽样（支持"AA-QQ"等范围表达）
- **任务D**：EV计算+盈亏平衡分析（将胜率转为决策建议）
- **任务E**：CLI增强+错误处理（更友好的用户体验）
- **缓存优化**：枚举结果缓存，避免重复计算

## 技术亮点

1. **智能化**：完全自动的方法选择，无需用户判断
2. **精确性**：枚举给出数学精确解，zero error
3. **鲁棒性**：复杂度保护+自动降级+错误恢复
4. **性能**：针对不同场景选择最优算法
5. **一致性**：统一接口，无缝集成到现有系统

这为德州扑克胜率分析建立了industry-leading的精度和智能化标准，特别是对于小规模精确场景的处理达到了理论最优水平。